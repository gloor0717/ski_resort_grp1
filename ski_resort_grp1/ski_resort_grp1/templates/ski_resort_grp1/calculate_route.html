{% extends 'ski_resort_grp1/base.html' %}

{% block title %}Calculate Route{% endblock %}

{% block content %}
<div class="container my-4">
    <h2>Calculate Route</h2>
    <form id="calculate-route-form">
        <div class="form-group">
            <label for="start">Start:</label>
            <select id="start" name="start" class="form-control">
                <option value="" disabled selected>Select start point</option>
                <optgroup label="Ski Routes">
                    {% for route in ski_routes %}
                    <option value="ski_route_{{ route.id }}">{{ route.name }}</option>
                    {% endfor %}
                </optgroup>
                <optgroup label="Ski Lifts">
                    {% for lift in ski_lifts %}
                    <option value="ski_lift_{{ lift.id }}">{{ lift.name }}</option>
                    {% endfor %}
                </optgroup>
                <optgroup label="Base Stations">
                    {% for base in base_stations %}
                    <option value="base_station_{{ base.id }}">{{ base.name }}</option>
                    {% endfor %}
                </optgroup>
            </select>
        </div>
        <div class="form-group">
            <label for="end">End:</label>
            <select id="end" name="end" class="form-control">
                <option value="" disabled selected>Select end point</option>
                <optgroup label="Ski Routes">
                    {% for route in ski_routes %}
                    <option value="ski_route_{{ route.id }}">{{ route.name }}</option>
                    {% endfor %}
                </optgroup>
                <optgroup label="Ski Lifts">
                    {% for lift in ski_lifts %}
                    <option value="ski_lift_{{ lift.id }}">{{ lift.name }}</option>
                    {% endfor %}
                </optgroup>
                <optgroup label="Base Stations">
                    {% for base in base_stations %}
                    <option value="base_station_{{ base.id }}">{{ base.name }}</option>
                    {% endfor %}
                </optgroup>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Calculate Route</button>
    </form>
    <div id="map" class="w-100" style="height: 500px; margin-top: 20px;"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/terraformer@1.0.11/terraformer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/terraformer-wkt-parser@1.2.1/terraformer-wkt-parser.min.js"></script>
<script>
    document.getElementById('calculate-route-form').addEventListener('submit', function (e) {
        e.preventDefault();

        var startSelect = document.getElementById('start');
        var endSelect = document.getElementById('end');
        var startValue = startSelect.value;
        var endValue = endSelect.value;

        if (startValue && endValue) {
            var startType = startValue.split('_')[0];
            var startId = startValue.split('_')[1];
            var endType = endValue.split('_')[0];
            var endId = endValue.split('_')[1];

            fetch('/calculate_route/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    start_type: startType,
                    start_id: startId,
                    end_type: endType,
                    end_id: endId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    var map = L.map('map', {
                        center: [46.31415226088029, 7.402238579358967],
                        zoom: 13,
                        minZoom: 9,
                        maxBounds: [
                            [45.5, 6.5],
                            [47.0, 8.5]
                        ]
                    });

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                    }).addTo(map);

                    var path = data.path.map(coord => [coord[1], coord[0]]);
                    L.polyline(path, { color: 'blue' }).addTo(map);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
</script>
{% endblock %}
